<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢—Ä–µ–Ω–∞–∂–µ—Ä –ì–∞—Ä—è—á–∏—Ö –ö–ª–∞–≤—ñ—à</title>
    <!-- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* –î–æ–¥–∞—Ç–∫–æ–≤—ñ —Å—Ç–∏–ª—ñ –¥–ª—è –≥—Ä–∏ */
        body {
            font-family: 'Inter', sans-serif;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* –°—Ç–∏–ª—å –¥–ª—è —Ç–∞–π–º–µ—Ä–∞ */
        #timer-bar {
            transition: width 0.1s linear;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ */
        @keyframes correct-flash {
            0% { background-color: #1f2937; } /* bg-gray-800 */
            50% { background-color: #22c55e; } /* –ó–µ–ª–µ–Ω–∏–π */
            100% { background-color: #1f2937; }
        }
        .correct-animation {
            animation: correct-flash 0.3s ease-out;
        }

        /* –ê–Ω—ñ–º–∞—Ü—ñ—è –¥–ª—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ */
        @keyframes incorrect-shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }
        .incorrect-animation {
            animation: incorrect-shake 0.3s ease-out;
            background-color: #ef4444; /* –ß–µ—Ä–≤–æ–Ω–∏–π */
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Ä–æ–±–æ—á–æ—ó –æ–±–ª–∞—Å—Ç—ñ */
        #workspace1, #workspace2 {
            font-family: monospace;
            caret-color: #34d399; /* –ö–æ–ª—ñ—Ä –∫—É—Ä—Å–æ—Ä–∞ */
            /* –ó–ê–ë–û–†–û–ù–ê –í–ò–î–Ü–õ–ï–ù–ù–Ø –ú–ò–®–ï–Æ */
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        /* –ü—Ä–∏—Ö–æ–≤—É—î–º–æ –∫—É—Ä—Å–æ—Ä, –∫–æ–ª–∏ –≤—ñ–Ω –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π */
        #workspace1:not(:focus), #workspace2:not(:focus) {
            caret-color: transparent;
        }
        
        .hidden {
            display: none;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è —Å–ø–∏—Å–∫—É –∑–∞–≤–¥–∞–Ω—å –†—ñ–≤–Ω—è 3 */
        #task-display ul {
            text-align: left;
            margin: 0 auto;
            padding: 0 20px;
            font-size: 1.5rem; /* 24px */
            line-height: 2rem; /* 32px */
            list-style: none;
            font-weight: 600; /* semibold */
        }
        #task-display li {
            padding: 4px 0;
            transition: all 0.2s ease-out;
        }
        .task-step-done {
            text-decoration: line-through;
            color: #6b7280; /* text-gray-500 */
        }
        .task-step-active {
            color: #ffffff; /* text-white */
            font-weight: 800; /* extrold */
            transform: scale(1.05);
        }
        .task-step-pending {
            color: #9ca3af; /* text-gray-400 */
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-4xl mx-auto bg-gray-800 rounded-2xl shadow-2xl p-6 md:p-10 transition-all">
        
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-4 text-cyan-400">–¢—Ä–µ–Ω–∞–∂–µ—Ä –ì–∞—Ä—è—á–∏—Ö –ö–ª–∞–≤—ñ—à</h1>
        
        <!-- –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó -->
        <div class="bg-gray-700 p-4 rounded-lg mb-6 text-sm">
            <p class="font-bold mb-2">–Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó:</p>
            <p class="mb-1">–í–∏–∫–æ–Ω—É–π—Ç–µ –∑–∞–≤–¥–∞–Ω–Ω—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≥–∞—Ä—è—á–∏—Ö –∫–ª–∞–≤—ñ—à. –®–≤–∏–¥–∫—ñ—Å—Ç—å –∑—Ä–æ—Å—Ç–∞—Ç–∏–º–µ!</p>
            <p class="mb-1"><strong class="text-yellow-300">–†—ñ–≤–µ–Ω—å 2 (–∑ 10 –±–∞–ª—ñ–≤):</strong> –ü–æ—Ç—Ä—ñ–±–Ω–æ <strong class="text-yellow-300">–∫–ª—ñ–∫–Ω—É—Ç–∏ –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–µ –ø–æ–ª–µ</strong>.</p>
            <p class="mb-2"><strong class="text-red-400">–†—ñ–≤–µ–Ω—å 3 (–∑ 20 –±–∞–ª—ñ–≤):</strong> –í–∏–∫–æ–Ω—É–π—Ç–µ <strong class="text-red-400">–ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ—Å—Ç—ñ –∑–∞–≤–¥–∞–Ω—å</strong> –ø–æ–∫—Ä–æ–∫–æ–≤–æ.</p>
            <ul class="list-disc list-inside">
                <li><strong class="text-cyan-300">–í–∏–¥—ñ–ª–∏—Ç–∏ –≤—Å–µ:</strong> Ctrl + A</li>
                <li><strong class="text-cyan-300">–ö–æ–ø—ñ—é–≤–∞—Ç–∏:</strong> Ctrl + C</li>
                <li><strong class="text-cyan-300">–í—Å—Ç–∞–≤–∏—Ç–∏:</strong> Ctrl + V</li>
                <li><strong class="text-cyan-300">–°–∫–∞—Å—É–≤–∞—Ç–∏:</strong> Ctrl + Z</li>
                <li><strong class="text-cyan-300">–í–∏–¥–∞–ª–∏—Ç–∏:</strong> Backspace (–ø—ñ—Å–ª—è –≤–∏–¥—ñ–ª–µ–Ω–Ω—è)</li>
            </ul>
        </div>

        <!-- –Ü–≥—Ä–æ–≤–∞ –∑–æ–Ω–∞ -->
        <div id="game-container" class="relative">
            <!-- –†–∞—Ö—É–Ω–æ–∫, –†—ñ–≤–µ–Ω—å —Ç–∞ –°–ø—Ä–æ–±–∏ -->
            <div class="absolute top-2 right-2 bg-gray-900 px-4 py-2 rounded-lg shadow-inner z-10 text-right">
                <div>
                    <span class="font-medium">–†–∞—Ö—É–Ω–æ–∫:</span>
                    <span id="score" class="font-bold text-2xl text-cyan-400">0</span>
                </div>
                <div>
                    <span class="font-medium">–†—ñ–≤–µ–Ω—å:</span>
                    <span id="level" class="font-bold text-2xl text-cyan-400">1</span>
                </div>
                <!-- –ù–û–í–ò–ô –ï–õ–ï–ú–ï–ù–¢: –°–ø—Ä–æ–±–∏ -->
                <div>
                    <span class="font-medium">–°–ø—Ä–æ–±–∏:</span>
                    <span id="lives" class="font-bold text-2xl text-yellow-400">2</span>
                </div>
            </div>

            <!-- –ó–∞–≤–¥–∞–Ω–Ω—è -->
            <div class="mb-4 text-center">
                 <p class="text-gray-400 text-lg mb-2">–ö–æ–º–∞–Ω–¥–∞:</p>
                <div id="task-display" class="font-extrabold text-white h-16 flex items-center justify-center">
                    <!-- –ó–∞–≤–¥–∞–Ω–Ω—è (–∞–±–æ —Å–ø–∏—Å–æ–∫) –∑'—è–≤–∏—Ç—å—Å—è —Ç—É—Ç -->
                </div>
                <!-- –ù–û–í–ò–ô –ï–õ–ï–ú–ï–ù–¢: –ü—ñ–¥–∫–∞–∑–∫–∞ -->
                <p id="hint-display" class="text-yellow-400 text-lg font-bold h-6 mt-2"></p>
            </div>

            <!-- –ó–æ–Ω–∞ –∑–∞–≤–¥–∞–Ω–Ω—è (–†–æ–±–æ—á–∞ –æ–±–ª–∞—Å—Ç—å) -->
            <div id="game-area" class="bg-gray-900 rounded-lg p-4 shadow-inner flex flex-col md:flex-row gap-4">
                
                <!-- –ü–æ–ª–µ 1 -->
                <div class="flex-1">
                    <label for="workspace1" class="mb-2 block text-center font-medium text-gray-400">–ü–æ–ª–µ 1</label>
                    <textarea 
                        id="workspace1" 
                        class="w-full h-48 bg-gray-800 text-white p-4 rounded-md border border-gray-700 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500 resize-none"
                        spellcheck="false"
                        oncontextmenu="return false;"
                    ></textarea>
                </div>
                
                <!-- –ü–æ–ª–µ 2 (–¥–ª—è –†—ñ–≤–Ω—è 2 —ñ 3) -->
                <div id="workspace2-container" class="flex-1 hidden">
                     <label for="workspace2" class="mb-2 block text-center font-medium text-gray-400">–ü–æ–ª–µ 2</label>
                    <textarea 
                        id="workspace2" 
                        class="w-full h-48 bg-gray-800 text-white p-4 rounded-md border border-gray-700 focus:outline-none focus:border-cyan-500 focus:ring-2 focus:ring-cyan-500 resize-none"
                        spellcheck="false"
                        oncontextmenu="return false;"
                    ></textarea>
                </div>

            </div>

            <!-- –¢–∞–π–º–µ—Ä -->
            <div class="w-full bg-gray-700 rounded-full h-4 mt-6 overflow-hidden shadow-inner">
                <div id="timer-bar" class="bg-cyan-500 h-4 rounded-full" style="width: 100%"></div>
            </div>
        </div>

        <!-- –û–≤–µ—Ä–ª–µ–π (–°—Ç–∞—Ä—Ç / –ö—ñ–Ω–µ—Ü—å –≥—Ä–∏) -->
        <div id="overlay" class="absolute inset-0 bg-gray-900 bg-opacity-95 flex flex-col items-center justify-center text-center p-4 rounded-2xl">
            <h2 id="overlay-title" class="text-4xl font-bold mb-4">–ü–æ—á–∞—Ç–∏ –≥—Ä—É</h2>
            <p id="overlay-score" class="text-2xl mb-6"></p>
            <button id="start-button" class="bg-cyan-500 hover:bg-cyan-400 text-gray-900 font-bold py-3 px-8 rounded-full text-xl shadow-lg transition-transform transform hover:scale-105">
                –ü–æ—á–∞—Ç–∏
            </button>
        </div>

    </div>

    <script>
        // --- DOM –ï–ª–µ–º–µ–Ω—Ç–∏ ---
        const scoreDisplay = document.getElementById('score');
        const levelDisplay = document.getElementById('level');
        const livesDisplay = document.getElementById('lives');
        const hintDisplay = document.getElementById('hint-display');
        const taskDisplay = document.getElementById('task-display');
        const timerBar = document.getElementById('timer-bar');
        const overlay = document.getElementById('overlay');
        const overlayTitle = document.getElementById('overlay-title');
        const overlayScore = document.getElementById('overlay-score');
        const startButton = document.getElementById('start-button');
        const gameArea = document.getElementById('game-area');
        const workspace1 = document.getElementById('workspace1');
        const workspace2 = document.getElementById('workspace2');
        const workspace2Container = document.getElementById('workspace2-container');

        // --- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥—Ä–∏ ---
        const LEVEL_UP_SCORE = 10;
        const LEVEL_3_UP_SCORE = 20;
        const STARTING_TIME = 10000;
        const STARTING_TIME_L3 = 10000;
        const MIN_TIME_L1_L2 = 1500;
        const MIN_TIME_L3 = 4000;
        const TIME_DECREMENT_FACTOR = 0.985;
        const LIVES_PER_TASK = 2;

        // --- –°—Ç–∞–Ω –≥—Ä–∏ ---
        let score = 0;
        let currentLevel = 1;
        let gameActive = false;
        let currentTaskKey = null;
        let currentSequence = null;
        let currentSequenceStep = 0;
        let currentIntervalTime = STARTING_TIME;
        let taskTimer = null;
        let timerInterval = null;
        let taskStartTime = 0;
        let taskLives = LIVES_PER_TASK;

        // --- –°—Ç–∞–Ω —Å–∏–º—É–ª—è—Ü—ñ—ó ---
        let gameClipboard = "";
        let undoState1 = "";
        let undoState2 = "";

        // --- –ë–ê–ù–ö –ó–ê–í–î–ê–ù–¨ (–†–Ü–í–ù–Ü 1-2) ---
        const TASKS = {
            'l1_select': { command: '–í–∏–¥—ñ–ª—ñ—Ç—å –≤—Å–µ!', key: 'KeyA', level: 1, fieldId: 'workspace1', 
                setup: () => { workspace1.value = "–¶–µ —è–∫–∏–π—Å—å —Ç–µ–∫—Å—Ç."; workspace2.value = ""; workspace1.blur(); },
                action: () => { workspace1.select(); }
            },
            'l1_copy': { command: '–°–∫–æ–ø—ñ—é–π—Ç–µ!', key: 'KeyC', level: 1, fieldId: 'workspace1', 
                setup: () => { workspace1.value = "–°–ï–ö–†–ï–¢–ù–ò–ô –ö–û–î 123"; workspace2.value = ""; workspace1.select(); },
                action: () => { const s = workspace1.value.substring(workspace1.selectionStart, workspace1.selectionEnd); gameClipboard = s || gameClipboard; }
            },
            'l1_paste': { command: '–í—Å—Ç–∞–≤—Ç–µ!', key: 'KeyV', level: 1, fieldId: 'workspace1', 
                setup: () => { workspace1.value = "–í—Å—Ç–∞–≤—Ç–µ —Ç–µ–∫—Å—Ç —Å—é–¥–∏: "; workspace2.value = ""; workspace1.setSelectionRange(workspace1.value.length, workspace1.value.length); },
                action: () => { workspace1.value += gameClipboard; }
            },
            'l1_undo': { command: '–°–∫–∞—Å—É–π—Ç–µ!', key: 'KeyZ', level: 1, fieldId: 'workspace1', 
                setup: () => { undoState1 = "–ü–æ—á–∞—Ç–∫–æ–≤–∏–π —Å—Ç–∞–Ω. "; workspace1.value = undoState1 + "–ó–ê–ô–í–ï!"; workspace2.value = ""; },
                action: () => { workspace1.value = undoState1; }
            },
            'l2_copy1': { command: '–°–∫–æ–ø—ñ—é–π—Ç–µ –∑ –ü–æ–ª—è 1', key: 'KeyC', level: 2, fieldId: 'workspace1', 
                setup: () => { workspace1.value = "–ö–û–î –î–õ–Ø –ü–û–õ–Ø 2"; workspace2.value = ""; workspace1.select(); },
                action: () => { const s = workspace1.value.substring(workspace1.selectionStart, workspace1.selectionEnd); gameClipboard = s || gameClipboard; }
            },
            'l2_paste2': { command: '–í—Å—Ç–∞–≤—Ç–µ —É –ü–æ–ª–µ 2', key: 'KeyV', level: 2, fieldId: 'workspace2', 
                setup: () => { workspace1.value = "(—Ç—É—Ç –º–∞—î –±—É—Ç–∏ –∫–æ–¥)"; workspace2.value = "–í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏: "; workspace2.setSelectionRange(workspace2.value.length, workspace2.value.length); },
                action: () => { workspace2.value += gameClipboard; }
            },
            'l2_select2': { command: '–í–∏–¥—ñ–ª–∏... —É –ü–æ–ª—ñ 2', key: 'KeyA', level: 2, fieldId: 'workspace2', 
                setup: () => { workspace1.value = "–¢–µ–∫—Å—Ç 1"; workspace2.value = "–¢–µ–∫—Å—Ç 2"; workspace2.blur(); },
                action: () => { workspace2.select(); }
            },
            'l2_undo1': { command: '–°–∫–∞—Å—É–π—Ç–µ —É –ü–æ–ª—ñ 1', key: 'KeyZ', level: 2, fieldId: 'workspace1', 
                setup: () => { undoState1 = "–ü–æ–ª–µ 1. "; workspace1.value = undoState1 + "–ó–ê–ô–í–ï"; workspace2.value = "–ü–æ–ª–µ 2"; },
                action: () => { workspace1.value = undoState1; }
            },
            'l2_delete1': { command: '–í–∏–¥–∞–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç!', key: 'Backspace', level: 2, fieldId: 'workspace1', 
                setup: () => { workspace1.value = "–í–ò–î–ê–õ–ò–¢–ò –¶–ï"; workspace2.value = "–¢—É—Ç –Ω—ñ—á–æ–≥–æ"; workspace1.select(); },
                action: () => { workspace1.value = ""; }
            },
            'l2_delete2': { command: '–í–∏–¥–∞–ª—ñ—Ç—å —É –ü–æ–ª—ñ 2!', key: 'Backspace', level: 2, fieldId: 'workspace2', 
                setup: () => { workspace1.value = "–¢—É—Ç –Ω—ñ—á–æ–≥–æ"; workspace2.value = "–í–ò–î–ê–õ–ò–¢–ò –¶–ï"; workspace2.select(); },
                action: () => { workspace2.value = ""; }
            }
        };
        const TASK_KEYS = Object.keys(TASKS);

        // --- –ë–ê–ù–ö –ü–û–°–õ–Ü–î–û–í–ù–û–°–¢–ï–ô (–†–Ü–í–ï–ù–¨ 3) ---
        const SEQUENCES = [
            {
                name: "–ö–æ–ø—ñ—é–≤–∞—Ç–∏ —ñ –í—Å—Ç–∞–≤–∏—Ç–∏",
                steps: [
                    { command: "–°–∫–æ–ø—ñ—é–π—Ç–µ –∑ –ü–æ–ª—è 1", key: 'KeyC', fieldId: 'workspace1', 
                      setup: () => { workspace1.value = "–ü–ï–†–ï–ù–ï–°–¢–ò –¶–ï–ô –¢–ï–ö–°–¢"; workspace2.value = "–°—é–¥–∏: "; workspace1.select(); },
                      action: () => { const s = workspace1.value.substring(workspace1.selectionStart, workspace1.selectionEnd); gameClipboard = s || gameClipboard; }
                    },
                    { command: "–í—Å—Ç–∞–≤—Ç–µ —É –ü–æ–ª–µ 2", key: 'KeyV', fieldId: 'workspace2', 
                      setup: () => { workspace2.setSelectionRange(workspace2.value.length, workspace2.value.length); },
                      action: () => { workspace2.value += gameClipboard; }
                    }
                ]
            },
            {
                name: "–û—á–∏—Å—Ç–∏—Ç–∏ –ü–æ–ª–µ 1",
                steps: [
                    { command: "–í–∏–¥—ñ–ª—ñ—Ç—å –≤—Å–µ —É –ü–æ–ª—ñ 1", key: 'KeyA', fieldId: 'workspace1', 
                      setup: () => { workspace1.value = "–ë–ê–ì–ê–¢–û –°–ú–Ü–¢–¢–Ø"; workspace2.value = "–ü–æ–ª–µ 2 —á–∏—Å—Ç–µ"; workspace1.blur(); },
                      action: () => { workspace1.select(); }
                    },
                    { command: "–í–∏–¥–∞–ª—ñ—Ç—å —Ç–µ–∫—Å—Ç", key: 'Backspace', fieldId: 'workspace1', 
                      setup: () => {}, 
                      action: () => { workspace1.value = ""; }
                    }
                ]
            },
            {
                name: "–ü–æ–≤–Ω–∞ –∑–∞–º—ñ–Ω–∞",
                steps: [
                    { command: "–í–∏–¥—ñ–ª—ñ—Ç—å –≤—Å–µ —É –ü–æ–ª—ñ 1", key: 'KeyA', fieldId: 'workspace1', 
                      setup: () => { workspace1.value = "–°–ï–ö–†–ï–¢ 123"; workspace2.value = "–ó–ê–ú–Ü–ù–ò–¢–ò –¶–ï"; },
                      action: () => { workspace1.select(); }
                    },
                    { command: "–°–∫–æ–ø—ñ—é–π—Ç–µ –∑ –ü–æ–ª—è 1", key: 'KeyC', fieldId: 'workspace1', 
                      setup: () => {},
                      action: () => { const s = workspace1.value.substring(workspace1.selectionStart, workspace1.selectionEnd); gameClipboard = s || gameClipboard; }
                    },
                    { command: "–í–∏–¥—ñ–ª—ñ—Ç—å –≤—Å–µ —É –ü–æ–ª—ñ 2", key: 'KeyA', fieldId: 'workspace2', 
                      setup: () => {},
                      action: () => { workspace2.select(); }
                    },
                    { command: "–í—Å—Ç–∞–≤—Ç–µ —É –ü–æ–ª–µ 2", key: 'KeyV', fieldId: 'workspace2', 
                      setup: () => {},
                      action: () => { workspace2.value = gameClipboard; }
                    }
                ]
            },
             {
                name: "–ü–µ—Ä–µ–º—ñ—â–µ–Ω–Ω—è —Ç–µ–∫—Å—Ç—É",
                steps: [
                    { command: "–í–∏–¥—ñ–ª—ñ—Ç—å –≤—Å–µ —É –ü–æ–ª—ñ 1", key: 'KeyA', fieldId: 'workspace1', 
                      setup: () => { workspace1.value = "–í–ê–ñ–õ–ò–í–Ü –î–ê–ù–Ü"; workspace2.value = "–°—Ç–∞—Ä–∏–π —Ç–µ–∫—Å—Ç"; undoState1 = "–í–ê–ñ–õ–ò–í–Ü –î–ê–ù–Ü"; },
                      action: () => { workspace1.select(); }
                    },
                    { command: "–°–∫–æ–ø—ñ—é–π—Ç–µ –∑ –ü–æ–ª—è 1", key: 'KeyC', fieldId: 'workspace1', 
                      setup: () => {},
                      action: () => { const s = workspace1.value.substring(workspace1.selectionStart, workspace1.selectionEnd); gameClipboard = s || gameClipboard; }
                    },
                    { command: "–í—Å—Ç–∞–≤—Ç–µ —É –ü–æ–ª–µ 2", key: 'KeyV', fieldId: 'workspace2', 
                      setup: () => { workspace2.value = "–í—Å—Ç–∞–≤—Ç–µ —Å—é–¥–∏: "; workspace2.setSelectionRange(workspace2.value.length, workspace2.value.length); },
                      action: () => { workspace2.value += gameClipboard; }
                    }
                ]
            }
        ];

        // --- –§—É–Ω–∫—Ü—ñ—ó ---

        function startGame() {
            score = 0;
            currentLevel = 1;
            currentIntervalTime = STARTING_TIME;
            gameActive = true;
            gameClipboard = "–ë–£–§–ï–† –û–ë–ú–Ü–ù–£";
            taskLives = LIVES_PER_TASK;
            livesDisplay.textContent = taskLives;
            hintDisplay.textContent = '';
            updateScoreDisplay();
            levelDisplay.textContent = '1';
            overlay.classList.add('hidden');
            workspace2Container.classList.add('hidden');
            workspace1.value = '–ì—Ä–∞ –ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è...';
            workspace2.value = '';
            nextTaskOrSequence();
        }

        function endGame() {
            gameActive = false;
            clearAllTimers();
            hintDisplay.textContent = '';
            overlayTitle.textContent = '–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!';
            overlayScore.textContent = `–í–∞—à —Ä–∞—Ö—É–Ω–æ–∫: ${score}`;
            startButton.textContent = '–°–ø—Ä–æ–±—É–≤–∞—Ç–∏ –∑–Ω–æ–≤—É';
            overlay.classList.remove('hidden');
            taskDisplay.innerHTML = 'üèÅ';
            workspace1.value = `–í–∞—à —Ñ—ñ–Ω–∞–ª—å–Ω–∏–π —Ä–∞—Ö—É–Ω–æ–∫: ${score}.`;
            workspace2.value = `–î—è–∫—É—é –∑–∞ –≥—Ä—É!`;
            workspace1.readOnly = true;
            workspace2.readOnly = true;
        }

        function nextTaskOrSequence() {
            if (!gameActive) return;
            clearAllTimers();
            taskLives = LIVES_PER_TASK;
            livesDisplay.textContent = taskLives;
            hintDisplay.textContent = '';

            if (currentLevel === 3) {
                taskDisplay.className = 'font-extrabold text-white h-auto py-4';
                currentSequence = SEQUENCES[Math.floor(Math.random() * SEQUENCES.length)];
                currentSequenceStep = 0;
                displayCurrentSequenceStep();
            } else {
                taskDisplay.className = 'text-4xl md:text-5xl font-extrabold text-white h-16 flex items-center justify-center';
                const availableTaskKeys = TASK_KEYS.filter(key => TASKS[key].level === currentLevel);
                let newTaskKey;
                do {
                    newTaskKey = availableTaskKeys[Math.floor(Math.random() * availableTaskKeys.length)];
                } while (newTaskKey === currentTaskKey);
                currentTaskKey = newTaskKey;
                const task = TASKS[currentTaskKey];
                taskDisplay.innerHTML = task.command;
                workspace1.readOnly = true;
                workspace2.readOnly = true;
                task.setup();
            }

            taskStartTime = Date.now();
            const timeForLevel = currentLevel === 3 ? STARTING_TIME_L3 : currentIntervalTime;
            taskTimer = setTimeout(endGame, timeForLevel);
            timerInterval = setInterval(updateTimerBar, 30);
            updateTimerBar();
        }
        
        function displayCurrentSequenceStep() {
            if (!currentSequence) return;
            const steps = currentSequence.steps;
            let listHtml = '<ul>';
            steps.forEach((step, index) => {
                let cssClass = 'task-step-pending';
                if (index < currentSequenceStep) {
                    cssClass = 'task-step-done';
                } else if (index === currentSequenceStep) {
                    cssClass = 'task-step-active';
                }
                listHtml += `<li class="${cssClass}"><span>${step.command}</span></li>`;
            });
            listHtml += '</ul>';
            taskDisplay.innerHTML = listHtml;
            const currentStep = steps[currentSequenceStep];
            if (currentStep.setup) {
                currentStep.setup();
            }
        }

        function getRequiredKeyInfo() {
            if (currentLevel === 3 && currentSequence) {
                return currentSequence.steps[currentSequenceStep];
            } else if (currentLevel < 3 && TASKS[currentTaskKey]) {
                return TASKS[currentTaskKey];
            }
            return null;
        }

        function showHint() {
            if (hintDisplay.textContent !== '') return;
            const taskInfo = getRequiredKeyInfo();
            if (!taskInfo) return;
            let hintText = "";
            if (taskInfo.key === 'Backspace') {
                hintText = "–ü—ñ–¥–∫–∞–∑–∫–∞: üëà Backspace";
            } else if (taskInfo.key.startsWith('Key')) {
                hintText = `–ü—ñ–¥–∫–∞–∑–∫–∞: Ctrl + ${taskInfo.key.replace('Key', '')}`;
            }
            hintDisplay.textContent = hintText;
        }

        function updateTimerBar() {
            if (!gameActive) return;
            const elapsedTime = Date.now() - taskStartTime;
            const timeForLevel = currentLevel === 3 ? STARTING_TIME_L3 : currentIntervalTime;
            const percentRemaining = 1 - (elapsedTime / timeForLevel);
            timerBar.style.width = (percentRemaining * 100) + '%';
            
            // **FIXED HINT LOGIC**
            // Shows hint precisely in the last 1/4 of time.
            if (percentRemaining <= 0.25) {
                showHint();
            }
        }
        
        function clearAllTimers() {
            clearTimeout(taskTimer);
            clearInterval(timerInterval);
            timerInterval = null;
            taskTimer = null;
        }

        function handleTaskLogic(pressedCode, activeFieldElement) {
            if (currentLevel === 3) {
                if (!currentSequence) return;
                const step = currentSequence.steps[currentSequenceStep];
                if (pressedCode === step.key && activeFieldElement.id === step.fieldId) {
                    step.action();
                    currentSequenceStep++;
                    if (currentSequenceStep >= currentSequence.steps.length) {
                        correctAnswer();
                    } else {
                        displayCurrentSequenceStep();
                    }
                } else {
                    handleIncorrectAttempt();
                }
            } else {
                const task = TASKS[currentTaskKey];
                if (!task) return;
                if (pressedCode === task.key && activeFieldElement.id === task.fieldId) {
                    task.action();
                    correctAnswer();
                } else {
                    handleIncorrectAttempt();
                }
            }
        }
        
        function handleKeyDown(e) {
            if (!gameActive) return;
            const pressedCode = e.code;
            const activeFieldElement = document.activeElement;
            const taskInfo = getRequiredKeyInfo();
            const requiredKeyCode = taskInfo ? taskInfo.key : null;

            if (e.ctrlKey) {
                e.preventDefault();
                handleTaskLogic(pressedCode, activeFieldElement);
            } else if (pressedCode === 'Backspace' && requiredKeyCode === 'Backspace') {
                e.preventDefault();
                handleTaskLogic(pressedCode, activeFieldElement);
            } else if (e.key.length === 1 && !e.ctrlKey && !e.metaKey && !e.altKey) {
                e.preventDefault();
                handleIncorrectAttempt();
            }
        }
        
        function correctAnswer() {
            score++;
            updateScoreDisplay();
            hintDisplay.textContent = '';
            let minTime = (currentLevel === 3) ? MIN_TIME_L3 : MIN_TIME_L1_L2;
            currentIntervalTime = Math.max(minTime, currentIntervalTime * TIME_DECREMENT_FACTOR);
            playCorrectAnimation();
            clearAllTimers();
            
            let delay = 200;
            if (currentLevel === 1 && score >= LEVEL_UP_SCORE) {
                currentLevel = 2;
                levelDisplay.textContent = '2';
                taskDisplay.innerHTML = '–†–Ü–í–ï–ù–¨ 2!';
                workspace2Container.classList.remove('hidden');
                delay = 1500;
            } else if (currentLevel === 2 && score >= LEVEL_3_UP_SCORE) {
                currentLevel = 3;
                levelDisplay.textContent = '3';
                currentIntervalTime = STARTING_TIME_L3; 
                taskDisplay.innerHTML = '–†–Ü–í–ï–ù–¨ 3!';
                delay = 2000;
            }
            
            setTimeout(nextTaskOrSequence, delay);
        }

        function updateScoreDisplay() {
            scoreDisplay.textContent = score;
        }

        function playCorrectAnimation() {
            gameArea.classList.add('correct-animation');
            setTimeout(() => {
                gameArea.classList.remove('correct-animation');
            }, 300);
        }
        
        // **FIXED "TWO TRIES" LOGIC**
        // This function now robustly handles the life counter.
        function handleIncorrectAttempt() {
            // Guard against multiple calls if game is already ending.
            if (!gameActive || taskLives <= 0) return;

            taskLives--;
            livesDisplay.textContent = taskLives;
            
            gameArea.classList.add('incorrect-animation');
            setTimeout(() => {
                gameArea.classList.remove('incorrect-animation');
            }, 300);

            // Game ends only when lives reach zero.
            if (taskLives <= 0) {
                // Deactivate game immediately to prevent further inputs.
                gameActive = false; 
                // Call endGame after a short delay for the animation to be seen.
                setTimeout(endGame, 100); 
            }
        }

        // --- –°–ª—É—Ö–∞—á—ñ –ü–æ–¥—ñ–π ---
        startButton.addEventListener('click', startGame);
        window.addEventListener('keydown', handleKeyDown);
        workspace1.addEventListener('focus', () => { if (!gameActive) workspace1.blur(); });
        workspace2.addEventListener('focus', () => { if (!gameActive) workspace2.blur(); });
    </script>

</body>
</html>
